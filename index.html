<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visitor Management System</title>
  <!-- Load jsPDF and html2canvas from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --danger: #e63946;
      --success: #2a9d8f;
      --light: #f8f9fa;
      --dark: #212529;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fb; color: var(--dark); padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: var(--primary); }
    .tabs { display: flex; gap: 10px; margin: 20px 0; }
    .tab-btn { padding: 10px 20px; background: #e9ecef; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .tab-content.active { display: block; }
    form { display: grid; gap: 15px; max-width: 600px; }
    .form-group { display: flex; flex-direction: column; }
    label { margin-bottom: 5px; font-weight: bold; }
    input, select, textarea { padding: 10px; border: 1px solid #ced4da; border-radius: 5px; }
    button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f1f3f5; }
    .photo-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
    .actions { display: flex; gap: 10px; margin: 15px 0; }
    
    /* PDF content styling (hidden visually but present in DOM) */
    #pdf-content {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 800px;
      background: white;
      padding: 20px;
    }
    .visitor-card-pdf {
      border: 1px solid #eee;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      display: flex;
      gap: 15px;
    }
    .visitor-card-pdf img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    .visitor-details { flex: 1; }
    
    video, canvas { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè¢ Visitor Management System</h1>
      <p>Track visitors entering and exiting the premises</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="register">Register Visitor</button>
      <button class="tab-btn" data-tab="current">Visitors On Premises</button>
    </div>

    <!-- Registration Form -->
    <div id="register" class="tab-content active">
      <h2>üìù Register New Visitor</h2>
      <form id="visitorForm">
        <div class="form-group">
          <label for="name">Full Name *</label>
          <input type="text" id="name" required />
        </div>
        <div class="form-group">
          <label for="email">Email ID *</label>
          <input type="email" id="email" required />
        </div>
        <div class="form-group">
          <label for="vehicle">Vehicle Number</label>
          <input type="text" id="vehicle" />
        </div>
        <div class="form-group">
          <label for="host">Visiting Whom / Office *</label>
          <input type="text" id="host" required placeholder="e.g., John Doe, Marketing Dept." />
        </div>
        <div class="form-group">
          <label for="purpose">Purpose of Visit</label>
          <textarea id="purpose" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Photo *</label>
          <div>
            <button type="button" class="btn-outline" id="captureBtn">üì∏ Capture Photo</button>
            <img id="photoPreview" style="display:none; width:100px; height:100px; object-fit:cover; margin-top:10px;" />
            <input type="hidden" id="photoData" />
          </div>
        </div>
        <button type="submit" class="btn-primary">‚úÖ Register & Time-In</button>
      </form>
    </div>

    <!-- Current Visitors -->
    <div id="current" class="tab-content">
      <h2>üë• Visitors Currently On Premises</h2>
      <div class="actions">
        <button id="generatePdf" class="btn-success">üìÑ Generate PDF Report</button>
        <button id="refreshList" class="btn-outline">üîÑ Refresh</button>
      </div>
      <div id="visitorsList"></div>
    </div>

    <!-- Camera elements -->
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <!-- Hidden PDF content container (off-screen, not display:none) -->
    <div id="pdf-content">
      <h2 style="text-align:center;">Visitor Report - On Premises</h2>
      <p style="text-align:center; margin-bottom:20px;">Generated on: <span id="report-date"></span></p>
      <div id="pdf-visitors-list"></div>
    </div>
  </div>

  <script>
    // Access jsPDF correctly from CDN
    const { jsPDF } = window.jspdf;

    document.addEventListener('DOMContentLoaded', () => {
      loadVisitors();
      setupTabs();
      setupForm();
      setupPdfButton();
      setupCamera();
    });

    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });
    }

    function setupForm() {
      const form = document.getElementById('visitorForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!document.getElementById('photoData').value) {
          alert('Please capture a photo!');
          return;
        }
        const visitor = {
          id: Date.now().toString(),
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          vehicle: document.getElementById('vehicle').value,
          host: document.getElementById('host').value,
          purpose: document.getElementById('purpose').value,
          photo: document.getElementById('photoData').value,
          timeIn: new Date().toLocaleString(),
          timeOut: null
        };
        saveVisitor(visitor);
        form.reset();
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('photoData').value = '';
        alert('Visitor registered successfully!');
        loadVisitors();
      });
    }

    let stream = null;
    function setupCamera() {
      const video = document.getElementById('video');
      const captureBtn = document.getElementById('captureBtn');
      const photoPreview = document.getElementById('photoPreview');
      const photoDataInput = document.getElementById('photoData');

      captureBtn.addEventListener('click', async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          video.style.display = 'block';
          video.width = 320;
          video.height = 240;

          // Hide video after 1.5s and take photo
          setTimeout(() => {
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            photoPreview.src = dataUrl;
            photoPreview.style.display = 'block';
            photoDataInput.value = dataUrl;

            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
          }, 1500);
        } catch (err) {
          alert('Camera access denied or not available. Try allowing camera permission.');
          console.error(err);
        }
      });
    }

    function saveVisitor(visitor) {
      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      visitors.push(visitor);
      localStorage.setItem('visitors', JSON.stringify(visitors));
    }

    function loadVisitors() {
      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      const currentVisitors = visitors.filter(v => v.timeOut === null);
      renderCurrentVisitors(currentVisitors);
    }

    function renderCurrentVisitors(visitors) {
      const container = document.getElementById('visitorsList');
      if (visitors.length === 0) {
        container.innerHTML = '<p style="padding:20px; text-align:center; color:#666;">No visitors currently on premises.</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Email</th>
            <th>Vehicle</th>
            <th>Visiting</th>
            <th>Time In</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>`;

      visitors.forEach(v => {
        html += `
          <tr>
            <td><img src="${v.photo}" class="photo-preview" /></td>
            <td>${v.name}</td>
            <td>${v.email}</td>
            <td>${v.vehicle || '‚Äî'}</td>
            <td>${v.host}</td>
            <td>${v.timeIn}</td>
            <td>
              <button class="btn-danger time-out-btn" data-id="${v.id}">‚è∞ Time Out</button>
            </td>
          </tr>`;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;

      document.querySelectorAll('.time-out-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          timeOutVisitor(id);
        });
      });
    }

    function timeOutVisitor(id) {
      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
      const visitor = visitors.find(v => v.id === id);
      if (visitor && visitor.timeOut === null) {
        visitor.timeOut = new Date().toLocaleString();
        localStorage.setItem('visitors', JSON.stringify(visitors));
        loadVisitors();
        alert(`${visitor.name} has been checked out.`);
      }
    }

    function setupPdfButton() {
      document.getElementById('generatePdf').addEventListener('click', () => {
        const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
        const currentVisitors = visitors.filter(v => v.timeOut === null);
        if (currentVisitors.length === 0) {
          alert('No visitors on premises to generate a report.');
          return;
        }

        // Fill PDF content
        document.getElementById('report-date').textContent = new Date().toLocaleString();
        const pdfList = document.getElementById('pdf-visitors-list');
        pdfList.innerHTML = '';

        currentVisitors.forEach(v => {
          const card = document.createElement('div');
          card.className = 'visitor-card-pdf';
          card.innerHTML = `
            <img src="${v.photo}" />
            <div class="visitor-details">
              <h3>${v.name}</h3>
              <p><strong>Email:</strong> ${v.email}</p>
              <p><strong>Vehicle:</strong> ${v.vehicle || '‚Äî'}</p>
              <p><strong>Visiting:</strong> ${v.host}</p>
              <p><strong>Purpose:</strong> ${v.purpose || '‚Äî'}</p>
              <p><strong>Time In:</strong> ${v.timeIn}</p>
            </div>
          `;
          pdfList.appendChild(card);
        });

        // Generate PDF
        const pdfContent = document.getElementById('pdf-content');
        html2canvas(pdfContent, { scale: 1.5 }).then(canvas => {
          const imgData = canvas.toDataURL('image/jpeg', 0.9);
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;

          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          pdf.save(`Visitor_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        });
      });

      document.getElementById('refreshList').addEventListener('click', loadVisitors);
    }
  </script>
</body>
</html>